import { Partitions } from "./partitions";
import { Submission } from 'dt-types';


const maxGrade = 3

export type S = Submission
const urls = {
	homework: 'https://freeuni-digital-technologies.github.io/homework/',
    web_homework: 'https://freeuni-digital-technologies.github.io/homework/web_hws.html'
}

function fileInfo(s: S) {
    return `
    ---

    рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЉрЃЏрЃБрЃџрЃћрЃЉрЃў рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃа рЃљрЃарЃўрЃА. 
    рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ рЃЎрЃџрЃљрЃАрЃарЃБрЃЏрЃќрЃћ: ${s.alternateLink.replace(/\.com\/c\//, '.com/u/2/c/')} 
    рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃљ: ${s.attachment!.downloadUrl.replace(/authuser=0/, 'authuser=2')}
    `
}


// TODO рЃљрЃЦ рЃЌрЃљрЃЋрЃўрЃАрЃўрЃЌ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃўрЃбрЃЮрЃА рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЊрЃарЃЮ рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ, рЃЎрЃЮрЃюрЃцрЃўрЃњрЃерЃў рЃгрЃћрЃарЃўрЃљ
const blocked = 'рЃљрЃЏ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃюрЃљрЃЉрЃўрЃ»рЃќрЃћ рЃЋрЃћрЃа рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА рЃЊрЃљ рЃАрЃ«рЃЋрЃљ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃўрЃА рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃљ рЃфрЃюрЃЮрЃЉрЃўрЃџрЃў рЃљрЃа рЃљрЃарЃўрЃА. рЃЌрЃБ рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЊрЃарЃЮ рЃЊрЃљрЃарЃЕрЃљ, рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃбрЃЋрЃўрЃарЃЌрЃЮ. \
            \
            рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃћрЃЉрЃў!'

export type EmailTemplate = (s: S) => string

export const templates: Partitions<EmailTemplate> = {
    late: (s: S) => `
        ${summaries.greeting(s)}

        рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЊрЃљрЃњрЃЋрЃўрЃљрЃюрЃћрЃЉрЃўрЃЌ рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ рЃЊрЃљ рЃЦрЃБрЃџрЃљ рЃљрЃа рЃЕрЃљрЃњрЃћрЃЌрЃЋрЃџрЃћрЃЉрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃБрЃЎрЃБрЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЏрЃўрЃќрЃюрЃўрЃЌ рЃњрЃўрЃњрЃќрЃљрЃЋрЃюрЃў рЃерЃћрЃЊрЃћрЃњрЃА:

        ${s.results}
        
        рЃўрЃљ
        
        ${fileInfo(s)}
    `,
    invalid: (s: S) => `
        ${summaries.greeting(s)}

        ${summaries.invalid(s)}

        рЃўрЃљ
        
        ${fileInfo(s)}
    `,

    // error/invalid рЃЏрЃћрЃАрЃўрЃ»рЃћрЃЉрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃћрЃарЃЌрЃњрЃљрЃю рЃњрЃљрЃгрЃћрЃарЃўрЃџрЃў рЃЊрЃљ рЃДрЃЋрЃћрЃџрЃљрЃА рЃЌрЃљрЃЋрЃўрЃАрЃў рЃЏрЃћрЃАрЃўрЃ»рЃў/рЃњрЃљрЃЏрЃЮрЃАрЃгрЃЮрЃарЃћрЃЉрЃљ рЃћрЃгрЃћрЃарЃЮрЃА
    error: (s: S) => `
        ${summaries.greeting(s)}
        
        <div>
        ${summaries.error(s)}
        </div>
        
        <p>рЃўрЃљ</p>
        
        ${fileInfo(s)}
    `,
    // TODO рЃърЃўрЃарЃЋрЃћрЃџрЃў/рЃЏрЃћрЃЮрЃарЃћ рЃЊрЃљ рЃљ.рЃе рЃЦрЃЮрЃюрЃЊрЃћрЃА рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљрЃАрЃљрЃф рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљрЃерЃў,
    // рЃљрЃАрЃћрЃЋрЃћ рЃџрЃўрЃюрЃЎрЃў рЃАрЃљрЃўрЃбрЃўрЃА.
    failed: (s: S) => {
        const failed = s.results.filter(r => !r.passed)
        const passed = s.results.filter(r => r.passed)
        const testCount = s.results.length
        const grade = passed.length/testCount
        const partiallyPassingMessage = `
             <p>
            рЃерЃћрЃюрЃў рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ рЃЊрЃљ рЃњрЃљрЃЊрЃўрЃА ${passed.length} рЃбрЃћрЃАрЃбрЃА ${testCount}-рЃЊрЃљрЃю. 
        рЃЦрЃБрЃџрЃљ рЃўрЃЦрЃюрЃћрЃЉрЃљ ${grade} ${maxGrade}-рЃЊрЃљрЃю. 
            <p>
            рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЊрЃљрЃЋрЃБрЃарЃЌрЃљрЃЋ, рЃарЃЮрЃЏрЃћрЃџрЃў рЃбрЃћрЃАрЃбрЃћрЃЉрЃў рЃЋрЃћрЃа рЃњрЃљрЃўрЃљрЃарЃљ рЃерЃћрЃюрЃЏрЃљ рЃЎрЃЮрЃЊрЃЏрЃљ. рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЌрЃБ рЃЊрЃарЃЮ рЃњрЃћрЃЦрЃюрЃћрЃЉрЃљ, рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљ рЃћрЃА рЃюрЃљрЃгрЃўрЃџрЃћрЃЉрЃўрЃф рЃњрЃљрЃЏрЃЮрЃљрЃАрЃгрЃЮрЃарЃЮ. 
            </p>
            <p>
            ${failed.map(t => t.message).join('</p><p>')}
            </p>
        </p>
        
        `
        const nonePassingMessage = `<p>рЃерЃћрЃюрЃЏрЃљ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљрЃЏ рЃерЃћрЃАрЃгрЃЮрЃарЃћрЃЉрЃўрЃАрЃљрЃА рЃбрЃћрЃАрЃбрЃћрЃЉрЃўрЃА рЃюрЃљрЃ«рЃћрЃЋрЃљрЃарЃќрЃћ рЃЏрЃћрЃбрЃў рЃЋрЃћрЃа рЃњрЃљрЃўрЃљрЃарЃљ (рЃЦрЃБрЃџрЃљ
            рЃљрЃарЃўрЃА ${grade} ${maxGrade}-рЃЊрЃљрЃю. рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃћрЃЉрЃБрЃџрЃў рЃ«рЃљрЃа, 
            рЃарЃЮрЃЏ рЃАрЃгрЃЮрЃарЃў рЃцрЃљрЃўрЃџрЃў рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ? рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃћ рЃерЃћрЃюрЃў рЃљрЃбрЃЋрЃўрЃарЃЌрЃБрЃџрЃў рЃцрЃљрЃўрЃџрЃў рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃЊрЃљ рЃюрЃљрЃ«рЃћ рЃарЃљ рЃЎрЃЮрЃЊрЃў рЃгрЃћрЃарЃўрЃљ. </p>`
        const message = grade < maxGrade/3 ? nonePassingMessage : partiallyPassingMessage
        return `
        ${summaries.greeting(s)}
        
        ${message}
        
        ${summaries.help}
        
        <p>рЃўрЃљ</p>
        
        ${fileInfo(s)}
    `},
    passed: (s: S) => `
        ${summaries.greeting(s)}

	   <p>рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЕрЃљрЃЉрЃљрЃарЃћрЃЉрЃБрЃџрЃўрЃљ ­ЪЦ│ </p>

        <p>рЃўрЃљ</p>
    `

}


export const summaries = {
    greeting: (s: S) => {
    return `<p>рЃњрЃљрЃЏрЃљрЃарЃ»рЃЮрЃЉрЃљ ${s.georgianName},</p>`
    },

    error: (s: S) => {
        return `
            рЃцрЃљрЃўрЃџрЃўрЃА рЃгрЃћрЃАрЃћрЃЉрЃўрЃф рЃАрЃарЃБрЃџрЃДрЃЮрЃцрЃўрЃџрЃљрЃЊ рЃњрЃљрЃЦрЃЋрЃА рЃЊрЃљрЃфрЃБрЃџрЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ 
            рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃБрЃарЃў рЃљрЃю рЃАрЃ«рЃЋрЃљ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮ рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃљ рЃЎрЃЮрЃЊрЃА рЃЋрЃћрЃа рЃБрЃерЃЋрЃћрЃЉрЃА. 

            рЃЏрЃћрЃўрЃџрЃА рЃЌрЃљрЃю рЃЋрЃБрЃарЃЌрЃљрЃЋ рЃбрЃћрЃАрЃбрЃћрЃарЃўрЃА рЃЏрЃћрЃАрЃўрЃ»рЃА.
            
            ${urls.homework}

            ${s.results}

            ${blocked}
            
            ${summaries.help}
        `
    },

    // LATER move to web
    invalid: (s: S) => {
        return `
            рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃљрЃарЃљрЃАрЃгрЃЮрЃа рЃцрЃЮрЃарЃЏрЃљрЃбрЃерЃўрЃљ рЃЊрЃљ рЃњрЃљрЃЏрЃАрЃгрЃЮрЃарЃћрЃЉрЃћрЃџрЃў рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃљ рЃЋрЃћрЃа рЃ«рЃАрЃюрЃўрЃА.
            <p>- рЃљрЃарЃфрЃћрЃарЃЌ рЃцрЃљрЃўрЃџрЃА рЃљрЃа рЃБрЃюрЃЊрЃљ рЃЦрЃЮрЃюрЃЊрЃћрЃА рЃАрЃљрЃ«рЃћрЃџрЃў рЃерЃћрЃфрЃЋрЃџрЃўрЃџрЃў</p>
            <p>- рЃцрЃљрЃўрЃџрЃћрЃЉрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЊрЃљрЃќрЃўрЃърЃБрЃџрЃў. рЃќрЃўрЃърЃў рЃерЃћрЃюрЃА email id-рЃўрЃА рЃБрЃюрЃЊрЃљ рЃерЃћрЃўрЃфрЃљрЃЋрЃЊрЃћрЃА</p>
            рЃЊрЃљрЃќрЃўрЃърЃЋрЃљ рЃЌрЃБ рЃљрЃа рЃўрЃфрЃў, рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃљ рЃљрЃЏ рЃњрЃЋрЃћрЃарЃЊрЃќрЃћрЃљ: ${urls.web_homework}.

            ${s.results.map(r => `<p>${r.details}</p>`)}
            
            ${summaries.help}
    `
    },

    help: (s: S) => `
            <p>рЃЌрЃБ рЃЕрЃћрЃЏрЃА рЃЏрЃЮрЃгрЃћрЃарЃўрЃџ рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљрЃерЃў рЃарЃљрЃЏрЃћ рЃљрЃарЃљрЃАрЃгрЃЮрЃарЃўрЃљ рЃљрЃю рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃљрЃерЃў рЃЊрЃљрЃ«рЃЏрЃљрЃарЃћрЃЉрЃљ рЃњрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ, рЃБрЃърЃљрЃАрЃБрЃ«рЃћ рЃљрЃЏ рЃЏрЃћрЃўрЃџрЃА.</p>
    `

}

